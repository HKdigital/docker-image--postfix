
# About

The image generated by this project can be used to run postfix, 
opendkim and fail2ban.


The folder `/docker-compose-example` contains an example using docker-compose.

# Usage

## Just try it out (using docker-compose)

See also the folder `/docker-compose-example`.

Below an example of using the image in a docker-compose file. This example will 
setup a container that listens to port 25.

```yaml
version: "3.9"

services:

  postfix:
    #
    # @see https://hub.docker.com/r/hkdigital/postfix
    #
    image: hkdigital/postfix

    restart: always

    environment:
      - MAIL_DOMAIN=mailer.yyy.zzz
      - SMTP_USER=auth@mailer.yyy.zzz:01234567890123456789

    ports:
      - "25:25"  # @note 25:25 does not work, quoting needed!?
                
    volumes:
      - ./volumes/postfix/domainkeys:/etc/opendkim/domainkeys
```

### Test the mail server (telnet example)

You can use telnet to test the server and to see how it actually works.

However, just using a mail client is easier...

```bash
# Convert your username (email) to base64 (use quotes to prevent issues)
$ echo -en "<username>" | base64
ZnJvbUBtYWlsZXIueXl5Lnp6eg==

# Convert your password to Base 64 (use quotes to prevent issues)
$ echo -en "<password>" | base64
cGFzc3dvcmQK

# 01234567890123456789 => MDEyMzQ1Njc4OTAxMjM0NTY3ODk=

telnet localhost 25

AUTH LOGIN
# 334 ..
ZnJvbUBtYWlsZXIueXl5Lnp6eg==    # <= encoded username
# 334 ..
MDEyMzQ1Njc4OTAxMjM0NTY3ODk=    # <= encoded password
# 235 2.7.0 Authentication successful


HELO mailer.yyy.zzz
MAIL FROM: from@mailer.yyy.zzz
RCPT TO: to@yyy.zzz
DATA
subject: test
Hello!
.
# 250 2.0.0 Ok: queued as ...
QUIT
```


## Setup production mail server

### Setup a DNS TXT record

For a production mail server, you probably want to setup an SPF record for your 
domain at your DNS provider.

    mailer.yyy.zzz  MX  <ip-or-domainname> 10
    mailer.yyy.zzz  TXT "v=spf1 mx ~all"    

This will tell receivers that receive mails from your server should be send from the ip or domain name that is specified in the MX record and that mails from other IP's or domains should be ignored.

Note [SPF records MUST be published as a DNS TXT](https://www.rfc-editor.org/rfc/rfc7208#section-3.1)

### DKIM

#### Generate DKIM signature

You can use an online service. E.g. https://tools.socketlabs.com/dkim/generator

Specify the domain name to mail from. The default (name of the) key selector used in this container is `mail`.

More info about DKIM [Create a DKIM record](https://dmarcian.com/create-a-dkim-record/).

#### Place the private key in a container volume

- Mount the volume `/etc/opendkim/domainkeys` from the container.
- Place the private key there in a file called `mail.private`.
- Place the public key there in a file called `mail.txt`.

#### Setup a DNS DKIM record

After generating the signarure add the public part to your DNS.

    mail._domainkey.mailer.yyy.zzz "v=DKIM1; k=rsa; p=MIGfMA..."

This record will give receivers the posibility to check if the message was signed by your mailserver.


### Double check your mail server configuration

- Look at "smtpd_relay_restrictions"
- ...

# Build locally

If you just want to use the image to create a container, there is no need to build the image locally. You can use the image from docker-hub.

Building the image locally is usually done for development of the image itself.

## Get a working copy from the repository

Clone the latest commit from github into a local working directory.

```bash
git clone --depth 1 \
  git@github.com:hkdigital/docker-image--postfix.git \
  hkdigital-postfix
```

## Build the docker image

```bash
./build-latest-image.sh
docker image ls
# Shows hkdigital-postfix
```
